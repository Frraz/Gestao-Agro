<!-- /src/templates/admin/fazendas/form.html -->

{% extends 'layouts/base.html' %}

{% block title %}Cadastro de Fazenda - Sistema de Gestão de Fazendas{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 text-gray-800">{% if fazenda is defined and fazenda.id %}Editar{% else %}Nova{% endif %} Fazenda/Área</h1>
        <a href="{{ url_for('admin.listar_fazendas') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">{% if fazenda is defined and fazenda.id %}Editar{% else %}Cadastrar{% endif %} Fazenda/Área</h6>
        </div>
        <div class="card-body">
            <form method="POST" class="needs-validation" novalidate>
                {{ form.csrf_token }}

                <div class="row mb-3">
                    <div class="col-md-6">
                        {{ form.nome.label(class="form-label") }}
                        {{ form.nome(class="form-control", id="nome", required=True) }}
                        {% if form.nome.errors %}
                            <div class="invalid-feedback d-block">{{ form.nome.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {{ form.matricula.label(class="form-label") }}
                        {{ form.matricula(class="form-control", id="matricula", required=True) }}
                        {% if form.matricula.errors %}
                            <div class="invalid-feedback d-block">{{ form.matricula.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        {% if form.recibo_car is defined %}
                            {{ form.recibo_car.label(class="form-label") }}
                            {{ form.recibo_car(class="form-control", id="recibo_car") }}
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        {{ form.tamanho_total.label(class="form-label") }}
                        {{ form.tamanho_total(class="form-control", id="tamanho_total", required=True, step="0.01") }}
                        {% if form.tamanho_total.errors %}
                            <div class="invalid-feedback d-block">{{ form.tamanho_total.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {{ form.area_consolidada.label(class="form-label") }}
                        {{ form.area_consolidada(class="form-control", id="area_consolidada", required=True, step="0.01") }}
                        {% if form.area_consolidada.errors %}
                            <div class="invalid-feedback d-block">{{ form.area_consolidada.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        {{ form.estado.label(class="form-label") }}
                        {{ form.estado(class="form-select", id="estado", required=True) }}
                        {% if form.estado.errors %}
                            <div class="invalid-feedback d-block">{{ form.estado.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-8">
                        {{ form.municipio.label(class="form-label") }}
                        {{ form.municipio(class="form-control", id="municipio", required=True) }}
                        {% if form.municipio.errors %}
                            <div class="invalid-feedback d-block">{{ form.municipio.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Associação de pessoas -->
                <fieldset class="border rounded p-3 mb-3">
                    <legend class="w-auto px-2">Pessoas Associadas</legend>
                    <div class="mb-2 text-muted" style="font-size:90%">
                        <i class="fas fa-info-circle"></i> Este campo é opcional. Você pode cadastrar uma fazenda sem associar nenhuma pessoa.
                    </div>
                    <div id="pessoas-fazenda-list">
                        {% for pf_form in form.pessoas_fazenda %}
                            <div class="row align-items-end mb-2 pessoa-fazenda-item">
                                <div class="col-md-6">
                                    {{ pf_form.pessoa_id.label(class="form-label") }}
                                    {{ pf_form.pessoa_id(class="form-select") }}
                                </div>
                                <div class="col-md-5">
                                    {{ pf_form.tipo_posse.label(class="form-label") }}
                                    {{ pf_form.tipo_posse(class="form-select") }}
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-danger btn-sm remove-pessoa-fazenda" title="Remover vínculo">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-success btn-sm" id="add-pessoa-fazenda"><i class="fas fa-plus"></i> Adicionar Pessoa</button>
                </fieldset>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> {% if fazenda is defined and fazenda.id %}Atualizar{% else %}Cadastrar{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let pessoasFazendaList = document.getElementById('pessoas-fazenda-list');
    let addBtn = document.getElementById('add-pessoa-fazenda');

    addBtn.addEventListener('click', function() {
        // Clona o último item (ou um modelo oculto) e limpa os valores
        let items = pessoasFazendaList.querySelectorAll('.pessoa-fazenda-item');
        let last = items.length ? items[items.length - 1] : null;
        if (last) {
            let clone = last.cloneNode(true);
            // Limpa valores
            for (const input of clone.querySelectorAll('input, select')) {
                input.value = '';
            }
            pessoasFazendaList.appendChild(clone);
        }
    });

    pessoasFazendaList.addEventListener('click', function(e) {
        if (e.target.closest('.remove-pessoa-fazenda')) {
            let item = e.target.closest('.pessoa-fazenda-item');
            if (pessoasFazendaList.children.length > 1) {
                item.remove();
            }
        }
    });
});
</script>
{% endblock %}
{% endblock %}